import { __assign, __spreadArrays } from "tslib";
import { Util } from '@antv/g2';
import { get } from '@antv/util';
import { getCanvasPattern } from '../utils/pattern';
import { deepAssign } from '../utils';
/**
 * Pattern é€šé“ï¼Œå¤„ç†å›¾æ¡ˆå¡«å……
 * ğŸš€ ç›®å‰æ”¯æŒå›¾è¡¨ç±»å‹ï¼šé¥¼å›¾ã€æŸ±çŠ¶å›¾ã€æ¡å½¢å›¾ã€ç‰çå›¾ç­‰ï¼ˆä¸æ”¯æŒåœ¨å¤š view å›¾è¡¨ä¸­ï¼Œåç»­æŒ‰éœ€æ‰©å±•ï¼‰
 *
 * @param key key of style property
 * @returns
 */
export function pattern(key) {
    var _this = this;
    return function (params) {
        var _a;
        var options = params.options, chart = params.chart;
        var patternOption = options.pattern;
        // æ²¡æœ‰ pattern é…ç½®ï¼Œåˆ™ç›´æ¥è¿”å›
        if (!patternOption) {
            return params;
        }
        /** ~~~~~~~ è¿›è¡Œè´´å›¾å›¾æ¡ˆå¤„ç† ~~~~~~~ */
        var style = function (datum) {
            var _a, _b, _c;
            var args = [];
            for (var _i = 1; _i < arguments.length; _i++) {
                args[_i - 1] = arguments[_i];
            }
            var defaultColor = chart.getTheme().defaultColor;
            var color = defaultColor;
            var colorAttribute = (_b = (_a = chart.geometries) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.getAttribute('color');
            if (colorAttribute) {
                var colorField = colorAttribute.getFields()[0];
                var seriesValue = get(datum, colorField);
                color = Util.getMappingValue(colorAttribute, seriesValue, ((_c = colorAttribute.values) === null || _c === void 0 ? void 0 : _c[0]) || defaultColor);
            }
            var pattern = patternOption;
            // 1. å¦‚æœ patternOption æ˜¯ä¸€ä¸ªå›è°ƒï¼Œåˆ™è·å–å›è°ƒç»“æœã€‚`(datum: Datum, color: string) => CanvasPattern`
            if (typeof patternOption === 'function') {
                pattern = patternOption.call(_this, datum, color);
            }
            // 2. å¦‚æœ pattern ä¸æ˜¯ CanvasPatternï¼Œåˆ™è¿›ä¸€æ­¥å¤„ç†ï¼Œå¦åˆ™ç›´æ¥èµ‹äºˆç»™ fill
            if (pattern instanceof CanvasPattern === false) {
                // é€šè¿‡ createPattern(PatternStyle) è½¬æ¢ä¸º CanvasPattern
                pattern = getCanvasPattern(deepAssign({}, { cfg: { backgroundColor: color } }, pattern));
            }
            var styleOption = options[key];
            return __assign(__assign({}, (typeof styleOption === 'function' ? styleOption.call.apply(styleOption, __spreadArrays([_this, datum], args)) : styleOption || {})), { fill: pattern || color });
        };
        return deepAssign({}, params, { options: (_a = {}, _a[key] = style, _a) });
    };
}
//# sourceMappingURL=pattern.js.map